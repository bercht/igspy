<div class="px-4 sm:px-0" data-controller="scraping-monitor" data-scraping-monitor-scraping-id-value="<%= @scraping.id %>" data-scraping-monitor-status-value="<%= @scraping.status %>">
  
  <div class="mb-8">
    <%= link_to "← Voltar", admin_igspy_path, class: "text-blue-600 hover:text-blue-800" %>
  </div>

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Scraping #<%= @scraping.scraping_id %></h1>
      
      <!-- Status Badge -->
      <span class="px-4 py-2 rounded-full text-sm font-semibold <%= status_badge_class(@scraping.status) %>" data-scraping-monitor-target="statusBadge">
        <%= @scraping.status.upcase %>
      </span>
    </div>

    <!-- Informações do Scraping -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Perfil Instagram</label>
        <p class="text-gray-900"><%= @scraping.profile_url %></p>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Postagens a Extrair</label>
        <p class="text-gray-900"><%= @scraping.results_limit %></p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Iniciado em</label>
        <p class="text-gray-900"><%= @scraping.started_at.strftime("%d/%m/%Y %H:%M:%S") %></p>
      </div>

      <% if @scraping.completed? && @scraping.completed_at.present? %>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Finalizado em</label>
          <p class="text-gray-900"><%= @scraping.completed_at.strftime("%d/%m/%Y %H:%M:%S") %></p>
        </div>
      <% else %>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status Atual</label>
          <p class="text-gray-900 font-semibold" data-scraping-monitor-target="statusMessage">
            <%= status_message_display(@scraping) %>
          </p>
        </div>
      <% end %>
    </div>

    <!-- Stepper Horizontal -->
    <div class="border-t pt-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">Progresso</h3>
      
      <div class="relative" data-scraping-monitor-target="timeline">
        <!-- Steps Container -->
        <div class="flex items-center justify-between">
          
          <!-- Step 1: Criado -->
          <div class="flex flex-col items-center flex-1">
            <div class="relative z-10">
              <%= render_stepper_icon('pending', @scraping.status) %>
            </div>
            <p class="mt-2 text-xs font-medium text-center <%= step_text_class('pending', @scraping.status) %>">
              Criado
            </p>
            <p class="text-xs text-gray-400 text-center">
              <%= @scraping.created_at.strftime("%H:%M") %>
            </p>
          </div>
          
          <!-- Connector 1-2 -->
          <div class="flex-1 h-0.5 <%= connector_class('fetching', @scraping.status) %> -mt-6"></div>
          
          <!-- Step 2: Coletando -->
          <div class="flex flex-col items-center flex-1">
            <div class="relative z-10">
              <%= render_stepper_icon('fetching', @scraping.status) %>
            </div>
            <p class="mt-2 text-xs font-medium text-center <%= step_text_class('fetching', @scraping.status) %>">
              Coletando
            </p>
            <p class="text-xs text-gray-400 text-center">Instagram</p>
          </div>
          
          <!-- Connector 2-3 -->
          <div class="flex-1 h-0.5 <%= connector_class('processing', @scraping.status) %> -mt-6"></div>
          
          <!-- Step 3: Processando -->
          <div class="flex flex-col items-center flex-1">
            <div class="relative z-10">
              <%= render_stepper_icon('processing', @scraping.status) %>
            </div>
            <p class="mt-2 text-xs font-medium text-center <%= step_text_class('processing', @scraping.status) %>">
              Processando
            </p>
            <p class="text-xs text-gray-400 text-center">Dados</p>
          </div>
          
          <!-- Connector 3-4 -->
          <div class="flex-1 h-0.5 <%= connector_class('completed', @scraping.status) %> -mt-6"></div>
          
          <!-- Step 4: Concluído -->
          <div class="flex flex-col items-center flex-1">
            <div class="relative z-10">
              <% if @scraping.failed? %>
                <%= render_stepper_icon('failed', @scraping.status) %>
              <% else %>
                <%= render_stepper_icon('completed', @scraping.status) %>
              <% end %>
            </div>
            <p class="mt-2 text-xs font-medium text-center <%= @scraping.failed? ? 'text-red-600' : step_text_class('completed', @scraping.status) %>">
              <%= @scraping.failed? ? 'Erro' : 'Concluído' %>
            </p>
            <% if @scraping.completed? && @scraping.completed_at.present? %>
              <p class="text-xs text-gray-400 text-center"><%= @scraping.completed_at.strftime("%H:%M") %></p>
            <% elsif @scraping.failed? %>
              <p class="text-xs text-red-400 text-center">Falhou</p>
            <% else %>
              <p class="text-xs text-gray-400 text-center">—</p>
            <% end %>
          </div>
          
        </div>
      </div>
      
      <!-- Status Message (quando em progresso) -->
      <% if @scraping.in_progress? || @scraping.pending? %>
        <div class="mt-6 flex items-center justify-center">
          <div class="flex items-center space-x-2 text-blue-600">
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium" data-scraping-monitor-target="progressText">
              <%= status_message_display(@scraping) %>
            </span>
          </div>
        </div>
      <% end %>
      
      <!-- Erro Message -->
      <% if @scraping.failed? %>
        <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-700">
            <strong>Erro:</strong> <%= @scraping.status_message %>
          </p>
        </div>
      <% end %>
    </div>

    <!-- Análise de IA -->
    <% if @scraping.completed? && @analysis&.analysis_text.present? %>
      <div class="border-t pt-6 mt-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-900 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Análise de Performance
          </h2>
          
          <% if @analysis.assistant_id.present? %>
            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
              ✓ Assistant Criado
            </span>
          <% end %>
        </div>

        <div class="prose max-w-none bg-gray-50 rounded-lg p-4">
          <%= simple_format(@analysis.analysis_text, class: "text-gray-700 leading-relaxed whitespace-pre-wrap text-sm") %>
        </div>

        <div class="mt-4 flex flex-wrap gap-3">
          <button 
            onclick="navigator.clipboard.writeText(document.querySelector('.prose').innerText); this.innerHTML='✓ Copiado!'; setTimeout(() => this.innerHTML='<svg class=\'w-4 h-4 mr-2 inline\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\' /></svg>Copiar Análise', 2000)"
            class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
            Copiar Análise
          </button>

          <% if @analysis.assistant_id.present? %>
            <%= link_to admin_conversation_path(@scraping), 
              class: "inline-flex items-center px-3 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <%= @scraping.conversation.present? ? "Continuar Conversa" : "Iniciar Conversa" %>
            <% end %>

            <%= link_to "https://platform.openai.com/playground/assistants?assistant=#{@analysis.assistant_id}", 
              target: "_blank",
              class: "inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              Abrir na OpenAI
            <% end %>
          <% end %>
        </div>
      </div>
    <% elsif @scraping.completed? && @analysis.nil? %>
      <!-- IA Analisando - integrado ao card principal -->
      <div class="border-t pt-6 mt-6">
        <div class="flex items-center justify-center p-6 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg border border-amber-200">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <svg class="animate-pulse w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
            </div>
            <div>
              <p class="text-amber-800 font-semibold">Gerando Análise com IA</p>
              <p class="text-amber-600 text-sm">Os dados foram coletados. A inteligência artificial está analisando...</p>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

</div>
